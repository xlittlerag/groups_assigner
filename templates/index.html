<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kendo Tournament Random Group Assignment</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            color: #333;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        h2 {
            color: #3498db;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-family: monospace;
        }
        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
        }
        .checkbox-group input {
            margin-right: 10px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            margin-right: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .results {
            margin-top: 30px;
        }
        .error {
            color: #e74c3c;
            padding: 10px;
            background-color: #fadbd8;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .success {
            color: #27ae60;
            padding: 10px;
            background-color: #d5f4e6;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .export-buttons {
            margin-top: 20px;
        }
        .export-buttons button {
            margin-right: 10px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background-color: #f1f1f1;
            border: 1px solid #ccc;
            cursor: pointer;
            margin-right: 5px;
        }
        .tab.active {
            background-color: #3498db;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .example {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-family: monospace;
            font-size: 14px;
        }
        .file-upload {
            margin-bottom: 15px;
        }
        .file-upload input {
            display: none;
        }
        .file-upload label {
            display: inline-block;
            padding: 10px 15px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        .file-upload label:hover {
            background-color: #e9ecef;
        }
        
        /* Enhanced group display styles */
        .groups-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        .group-card {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-width: 280px;
            flex: 1;
            max-width: 350px;
        }
        .group-header {
            background-color: #3498db;
            color: white;
            padding: 10px;
            margin: -15px -15px 15px -15px;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            font-size: 18px;
            text-align: center;
        }
        .competitor-row {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .competitor-row:last-child {
            border-bottom: none;
        }
        .position-badge {
            background-color: #e74c3c;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
            font-size: 14px;
        }
        .competitor-info {
            flex: 1;
        }
        .competitor-name {
            font-weight: bold;
            color: #2c3e50;
        }
        .country-badge {
            background-color: #f39c12;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 8px;
        }
        .summary-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat-card {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            min-width: 150px;
            margin: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }
        .stat-label {
            color: #555;
            font-size: 14px;
            margin-top: 5px;
        }
        .collision-highlight {
            background-color: #ffebee;
            border-left: 4px solid #e74c3c;
            padding-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Kendo Tournament Random Group Assignment</h1>
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('input')">Input Data</div>
            <div class="tab" onclick="showTab('results')">Results</div>
        </div>
        
        <div id="input-tab" class="tab-content active">
            <div class="section">
                <h2>Competitors</h2>
                <div class="file-upload">
                    <label for="competitors-file">Upload CSV/JSON file</label>
                    <input type="file" id="competitors-file" accept=".csv,.json" onchange="handleFileUpload('competitors')">
                </div>
                <div class="form-group">
                    <label for="competitors">Competitors (JSON format):</label>
                    <textarea id="competitors" rows="10" placeholder='[{"name": "John Doe", "country": "USA"}, {"name": "Jane Smith", "country": "Canada"}]'></textarea>
                </div>
                <div class="example">
                    Example: [{"name": "John Doe", "country": "USA"}, {"name": "Jane Smith", "country": "Canada"}]
                </div>
            </div>
            
            <div class="section">
                <h2>Groups</h2>
                <div class="file-upload">
                    <label for="groups-file">Upload CSV/JSON file</label>
                    <input type="file" id="groups-file" accept=".csv,.json" onchange="handleFileUpload('groups')">
                </div>
                <div class="form-group">
                    <label for="groups">Groups (JSON format):</label>
                    <textarea id="groups" rows="10" placeholder='[{"id": "g1", "capacity": 4}, {"id": "g2", "capacity": 3}]'></textarea>
                </div>
                <div class="example">
                    Example: [{"id": "g1", "capacity": 4}, {"id": "g2", "capacity": 3}]
                </div>
            </div>
            
            <div class="section">
                <h2>Fixed Positions (Optional)</h2>
                <div class="file-upload">
                    <label for="fixed-positions-file">Upload CSV/JSON file</label>
                    <input type="file" id="fixed-positions-file" accept=".csv,.json" onchange="handleFileUpload('fixed-positions')">
                </div>
                <div class="form-group">
                    <label for="fixed_positions">Fixed Positions (JSON format):</label>
                    <textarea id="fixed_positions" rows="10" placeholder='[{"competitor_name": "John Doe", "group_id": "g1", "position": "a"}]'></textarea>
                </div>
                <div class="example">
                    Example CSV:<br>
                    competitor_name,group_id,position<br>
                    John Doe,1,a<br>
                    <br>
                    Example JSON:<br>
                    [{"competitor_name": "John Doe", "group_id": "g1", "position": "a"}]
                </div>
            </div>
            
            <div class="section">
                <h2>Options</h2>
                <div class="form-group">
                    <label for="random_seed">Random Seed (optional, for reproducibility):</label>
                    <input type="number" id="random_seed" placeholder="Leave empty for random seed">
                </div>
                <div class="form-group">
                    <label for="max_time">Max Time (seconds):</label>
                    <input type="number" id="max_time" value="10" min="1" max="60">
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="minimization" checked>
                        <label for="minimization">Minimize same-country collisions</label>
                    </div>
                </div>
                <button onclick="validateInputs()">Validate Inputs</button>
                <button onclick="runDraw()">Run Draw</button>
            </div>
            
            <div id="message"></div>
        </div>
        
        <div id="results-tab" class="tab-content">
            <div class="section">
                <h2>Assignment Results</h2>
                <div id="results-content">
                    <p>No results yet. Please run a draw first.</p>
                </div>
                <div id="export-buttons" class="export-buttons" style="display: none;">
                    <button onclick="exportResults('json')">Export as JSON</button>
                    <button onclick="exportResults('csv')">Export as CSV</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentResultHash = null;
        let competitorsHash = null;
        let groupsHash = null;
        let fixedPositionsHash = null;
        
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }
        
        function showMessage(message, isError = false) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = `<div class="${isError ? 'error' : 'success'}">${message}</div>`;
            
            // Clear message after 5 seconds
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 5000);
        }
        
        // Helper function to parse a CSV line, handling quoted fields
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            // Add the last field
            result.push(current.trim());
            
            return result;
        }
        
        function handleFileUpload(type) {
            const fileInput = document.getElementById(`${type}-file`);
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const content = e.target.result;
                
                if (file.name.endsWith('.json')) {
                    try {
                        const data = JSON.parse(content);
                        document.getElementById(type).value = JSON.stringify(data, null, 2);
                        showMessage(`Successfully loaded ${data.length} records from JSON`);
                    } catch (error) {
                        showMessage(`Error parsing JSON file: ${error.message}`, true);
                    }
                } else if (file.name.endsWith('.csv')) {
                    try {
                        // Parse CSV with better handling for quoted fields
                        const lines = content.split('\n').filter(line => line.trim());
                        if (lines.length < 2) {
                            showMessage('CSV file must have at least a header and one data row', true);
                            return;
                        }
                        
                        // Parse header
                        const headers = parseCSVLine(lines[0]);
                        
                        // Parse data rows
                        const data = [];
                        for (let i = 1; i < lines.length; i++) {
                            const values = parseCSVLine(lines[i]);
                            if (values.length !== headers.length) {
                                showMessage(`Row ${i+1} has ${values.length} values but header has ${headers.length} values`, true);
                                return;
                            }
                            
                            const obj = {};
                            for (let j = 0; j < headers.length; j++) {
                                let value = values[j];
                                
                                // Special handling for fixed positions to ensure proper data types
                                if (type === 'fixed_positions') {
                                    if (headers[j] === 'group_id') {
                                        // Keep group_id as string to ensure consistency
                                        value = String(value);
                                    } else if (headers[j] === 'position') {
                                        // Ensure position is a single lowercase letter
                                        value = String(value).toLowerCase().trim();
                                    }
                                } else {
                                    // Try to parse as number for other types
                                    if (!isNaN(value) && value !== '') {
                                        value = parseFloat(value);
                                    }
                                }
                                
                                obj[headers[j]] = value;
                            }
                            
                            data.push(obj);
                        }
                        
                        document.getElementById(type).value = JSON.stringify(data, null, 2);
                        showMessage(`Successfully loaded ${data.length} records from CSV`);
                    } catch (error) {
                        showMessage(`Error parsing CSV file: ${error.message}`, true);
                    }
                }
            };
            
            reader.readAsText(file);
        }
        
        async function uploadData(endpoint, data) {
            try {
                const response = await fetch(`/api/${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Unknown error');
                }
                
                return result;
            } catch (error) {
                throw error;
            }
        }
        
        async function validateInputs() {
            try {
                // Get input data
                const competitorsText = document.getElementById('competitors').value.trim();
                const groupsText = document.getElementById('groups').value.trim();
                const fixedPositionsText = document.getElementById('fixed_positions').value.trim();
                
                // Validate inputs
                if (!competitorsText) {
                    showMessage('Please provide competitors data', true);
                    return;
                }
                
                if (!groupsText) {
                    showMessage('Please provide groups data', true);
                    return;
                }
                
                // Parse JSON
                let competitors, groups, fixedPositions = [];
                
                try {
                    competitors = JSON.parse(competitorsText);
                    groups = JSON.parse(groupsText);
                    
                    if (fixedPositionsText) {
                        fixedPositions = JSON.parse(fixedPositionsText);
                    }
                } catch (error) {
                    showMessage('Invalid JSON format: ' + error.message, true);
                    return;
                }
                
                // Upload data
                const competitorsResult = await uploadData('competitors', competitors);
                const groupsResult = await uploadData('groups', groups);
                
                competitorsHash = competitorsResult.hash;
                groupsHash = groupsResult.hash;
                
                let fixedPositionsResult = null;
                if (fixedPositions.length > 0) {
                    fixedPositionsResult = await uploadData('fixed_positions', fixedPositions);
                    fixedPositionsHash = fixedPositionsResult.hash;
                }
                
                // Validate inputs
                const validateData = {
                    competitors_hash: competitorsHash,
                    groups_hash: groupsHash
                };
                
                if (fixedPositionsHash) {
                    validateData.fixed_positions_hash = fixedPositionsHash;
                }
                
                const validateResponse = await fetch('/api/validate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(validateData)
                });
                
                const validateResult = await validateResponse.json();
                
                if (!validateResponse.ok) {
                    throw new Error(validateResult.error || 'Unknown error');
                }
                
                if (validateResult.valid) {
                    showMessage('Inputs are valid!');
                } else {
                    showMessage(validateResult.message, true);
                }
                
            } catch (error) {
                showMessage('Error: ' + error.message, true);
            }
        }
        
        async function runDraw() {
            try {
                // First validate inputs
                await validateInputs();
                
                // Get options
                const randomSeed = document.getElementById('random_seed').value;
                const minimization = document.getElementById('minimization').checked;
                const maxTime = document.getElementById('max_time').value;
                
                // Run draw
                const drawData = {
                    competitors_hash: competitorsHash,
                    groups_hash: groupsHash,
                    minimization: minimization,
                    max_time_seconds: parseInt(maxTime)
                };
                
                if (fixedPositionsHash) {
                    drawData.fixed_positions_hash = fixedPositionsHash;
                }
                
                if (randomSeed) {
                    drawData.random_seed = parseInt(randomSeed);
                }
                
                const drawResponse = await fetch('/api/draw', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(drawData)
                });
                
                const drawResult = await drawResponse.json();
                
                if (!drawResponse.ok) {
                    throw new Error(drawResult.error || 'Unknown error');
                }
                
                // Store result hash for export
                currentResultHash = drawResult.result_hash;
                
                // Display results
                displayResults(drawResult);
                
                // Show success message
                showMessage('Draw completed successfully!');
                
                // Switch to results tab
                document.querySelector('.tab:nth-child(2)').click();
                
            } catch (error) {
                showMessage('Error: ' + error.message, true);
            }
        }
        
        function displayResults(result) {
            const resultsContent = document.getElementById('results-content');
            const exportButtons = document.getElementById('export-buttons');
            
            // Create summary section
            let summaryHtml = `
                <div class="summary-stats">
                    <div class="stat-card">
                        <div class="stat-value">${result.summary.total_collisions}</div>
                        <div class="stat-label">Total Collisions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${result.summary.random_seed || 'Random'}</div>
                        <div class="stat-label">Random Seed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${Object.keys(result.summary.per_country_collisions).length}</div>
                        <div class="stat-label">Countries with Collisions</div>
                    </div>
                </div>
                
                <h3>Per-Country Collisions</h3>
                <div class="summary-stats">
            `;
            
            for (const [country, count] of Object.entries(result.summary.per_country_collisions)) {
                const collisionClass = count > 0 ? 'collision-highlight' : '';
                summaryHtml += `
                    <div class="stat-card ${collisionClass}">
                        <div class="stat-value">${count}</div>
                        <div class="stat-label">${country}</div>
                    </div>
                `;
            }
            
            summaryHtml += '</div>';
            
            // Create enhanced group display
            // Group assignments by group_id and sort numerically
            const groups = {};
            for (const assignment of result.assignment) {
                if (!groups[assignment.group_id]) {
                    groups[assignment.group_id] = [];
                }
                groups[assignment.group_id].push(assignment);
            }
            
            // Sort group IDs numerically
            const sortedGroupIds = Object.keys(groups).sort((a, b) => {
                return parseInt(a) - parseInt(b);
            });
            
            let groupsHtml = '<h3>Group Assignments</h3><div class="groups-container">';
            
            for (const groupId of sortedGroupIds) {
                const competitors = groups[groupId];
                
                // Sort competitors by position
                competitors.sort((a, b) => a.position.localeCompare(b.position));
                
                groupsHtml += `
                    <div class="group-card">
                        <div class="group-header">Group ${groupId}</div>
                `;
                
                for (const competitor of competitors) {
                    groupsHtml += `
                        <div class="competitor-row">
                            <div class="position-badge">${competitor.position.toUpperCase()}</div>
                            <div class="competitor-info">
                                <div class="competitor-name">${competitor.name}</div>
                            </div>
                            <div class="country-badge">${competitor.country}</div>
                        </div>
                    `;
                }
                
                groupsHtml += '</div>';
            }
            
            groupsHtml += '</div>';
            
            resultsContent.innerHTML = summaryHtml + groupsHtml;
            exportButtons.style.display = 'block';
        }
        
        function exportResults(format) {
            if (!currentResultHash) {
                showMessage('No results to export', true);
                return;
            }
            
            window.open(`/api/results/${currentResultHash}/export?format=${format}`, '_blank');
        }
    </script>
</body>
</html>
